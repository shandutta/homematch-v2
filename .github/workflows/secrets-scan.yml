name: Secrets Scan

on:
  pull_request:
  push:
    branches:
      - main
      - master

env:
  SECRETS_SCAN_HISTORY: ${{ vars.SECRETS_SCAN_HISTORY || 'true' }}

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install git-secrets
        run: |
          set -euo pipefail
          if command -v git-secrets >/dev/null 2>&1; then
            exit 0
          fi
          tmpdir="$(mktemp -d)"
          trap 'rm -rf "$tmpdir"' EXIT
          git clone --depth 1 https://github.com/awslabs/git-secrets.git "$tmpdir"
          sudo make -C "$tmpdir" install

      - name: Configure git-secrets
        run: |
          set -euo pipefail
          git secrets --install
          git secrets --register-aws
          if [[ -f .git-secrets-patterns ]]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              line="$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
              [[ -z "$line" || "$line" =~ ^# ]] && continue
              if git secrets --list 2>/dev/null | grep -F -- "$line" >/dev/null 2>&1; then
                continue
              fi
              git secrets --add "$line"
            done < .git-secrets-patterns
          fi

      - name: Scan repository
        run: |
          set -euo pipefail
          git secrets --scan --untracked
          if [[ "${SECRETS_SCAN_HISTORY:-}" == "1" || "${SECRETS_SCAN_HISTORY:-}" == "true" ]]; then
            if git secrets --help 2>&1 | grep -q -- '--scan-history'; then
              git fetch --prune --unshallow 2>/dev/null || git fetch --prune --depth=0
              git secrets --scan-history
            else
              echo "git-secrets does not support --scan-history; skipping." >&2
            fi
          fi
